# Планирование: анализ, идентификация проблем и поиск решений

## Существующие и потенциальные проблемные места

1) Представители компаний и пользователи жалуются на просроченные и не реализованные заказы. Они где-то застревают или теряются.
2) Первая страница MES долго прогружается, несмотря на реализацию пагинации и фильтров. Операторы не могут просматривать новые заказы.
3) Тесты и деплой в продакшн вручную, задержки при релизах могут достигать месяца, т.к. каждая итерация тестирования долгая
4) Отсутствие нагрузочного тестирования, который бы мог помочь выявить боттлнеки
5) База данных и инстансы приложений в единственном экземпляре, нет возможности масштабирования при увеличении нагрузки
6) Приложение MES в единственном экземпляре. При росте нагрузки оно перестает успевать рассчитывать стоимость детали, с учетом что одна деталь может рассчитываться до 30 мин

## Инициативы по улучшению системы

Первым делом предлагаю реализовать паттерны отказоустойчивости. Кажется основная проблема возникает с MES Api, это очень перегруженный сервис.
Так как запрос на расчет стоимости уже через RabbitMq, то можно реализовать паттерн BackPreassure на стороне Mes Api, чтобы не начинать расчет заказа по ивенту из RabbitMQ. Но если консьюмеры будут долго ждать при обработке ивента, RabbitMq может подумать, что консьюмер умер, и перераспределит консьюмеров. В этом случае логично сделать возможность посылать сигнал о перегрузе в CRM, чтобы она уменьшила кол-во издаваемых ивентов в секунду.

Далее, для ускорения загрузки MES реализуем кэширование. Кэш будет автоматически обновляться согласно паттерну Read Ahead. 
Сортировку предлагаю сделать от старых заказов к новым, чтобы удовлетворить клиентов, которые долго ожидают свой заказ.

Добавляем юнит и интеграционные тесты. Также, автоматизируем e2e тесты, добавляем нагрузочное. Обговариваем что каждая фича должна быть покрыта минимум 2-3 тестами на метод. Тогда ускорится процесс тестирования. 
Деплой в дальнейшем имеет смысл автоматизировать. Можем добавить сине-зеленые релизы, чтобы при возникновении беды была возможность быстро переключить трафик.

Выносим часть с расчетом стоимости детали в отдельный микросервис и масштабируем его. Паралелльно команда разработки добавляет метрики, чтобы мы могли оценить эффективность масштабирования.

База данных в единственном экземпляре это ненадежно и может быть медленно. Можно создать master-slave репликацию. Это добавит отказоустойчивости и ускорит чтение данных посредством read-replica.

## Инициативы в порядке приоритетности
1) Добавляем паттерны circuit breaker и backpreassure для Mes Api;
2) Добавляем кэширование заказов. В MES делаем фильтрацию от старых к новым;
3) Вынести расчет детали в отдельный микросервис, реализовать горизонтельное масштабирование;
4) Реплицируем базу данных. Также делаем бекапы;
5) Покрываем код юнит и интеграционными тестами, ускоряем процесс тестирования;
6) Делаем нагрузочное тестирование системы, определяем боттлнеки;
7) Добавляем метрики на уровне сервисов;